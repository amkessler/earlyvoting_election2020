---
title: "2020 Election Early Voting Summaries and Demographics"
author: "Aaron Kessler"
date: "10/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(lubridate)
library(readxl)
library(writexl)
library(tidycensus)
library(kableExtra)
options(scipen = 999)
options(dplyr.summarise.inform=F)


#run processing script to refresh with latest data as needed each day
# source("02_analysis.R")

# alternatively, use saved versions of files already created (much faster when new updated data not needed)
state_bothcycles <- readRDS("processed_data/state_bothcycles.rds")
# county_bothcycles <- readRDS("processed_data/county_bothcycles.rds")
natl_grandtots_bothyears <- readRDS("processed_data/natl_grandtots_bothyears.rds")
state_grandtots_bothyears <- readRDS("processed_data/state_grandtots_bothyears.rds")
# county_grandtots_bothyears <- readRDS("processed_data/county_grandtots_bothyears.rds")

# load lookup file with key state designations for prez and senate
keystates_lookup <- read_excel("processed_data/keystates_elex2020.xlsx")


#pull national votes cast/return number for use below
value_national_2016 <- natl_grandtots_bothyears %>% pull(x2016)
value_national_2020 <- natl_grandtots_bothyears %>% pull(x2020)
value_national_pctchg <- natl_grandtots_bothyears %>% pull(pctchg_returned) %>% round_half_up(1)

#we'll use use prez battlegrounds, create a vector to filer on
keystates_prez_vector <- keystates_lookup %>% 
  filter(office == "P") %>% 
  distinct(state) %>% 
  pull()

#use those values to create a subset of the states table
state_keyprezonly_bothcycles <- state_bothcycles %>% 
  filter(state %in% keystates_prez_vector)

state_keyprezonly_bothcycles


#we'll use use senate key races, create a vector to filer on
keystates_senate_vector <- keystates_lookup %>% 
  filter(office == "S") %>% 
  distinct(state) %>% 
  pull()

#use those values to create a subset of the states table
state_keysenateonly_bothcycles <- state_bothcycles %>% 
  filter(state %in% keystates_senate_vector)

state_keysenateonly_bothcycles



#### CHOOSE WHAT FILTERED DATASET TO USE FOR ANALYSIS
#select which filtered version of the full dataset to use below, or create new one
votedata <- state_keyprezonly_bothcycles

#note: something strange happening with PA. Will troubleshoot and until then just taking it out for now
votedata <- votedata %>% 
  filter(state != "PA")



```

Bloomberg is partnering with Catalist, a data company that works with Democrats and others, to compile counts of ballots cast before Election Day, either early in-person or by-mail. The data is being provided each weekday morning.

As of the morning of `r format(Sys.Date(), "%B %d, %Y")`, at least **`r format(value_national_2020, big.mark=",")`** votes have been cast early or by mail nationwide, according to data collected by Catalist. This represents a **`r format(value_national_pctchg)`** percent change from 2016, when `r format(value_national_2016, big.mark=",")` votes were cast at this point.  
  
Details on ballots cast in selected states follow:

## Battleground State Totals

```{r, echo=FALSE}

#note: something strange happening with PA. Will troubleshoot and until then just taking it out for now
state_grandtots_bothyears <- state_grandtots_bothyears %>% 
  filter(state != "PA")


state_grandtots_bothyears %>% 
  filter(state %in% keystates_prez_vector) %>% 
  select(state,
    "ballots cast at this point 2016" = total_returned_2016,
    "ballots cast to date 2020" = total_returned_2016,
    difference = diff_returned,
    "percent change" = pctchg_returned) %>% 
  kable(format.args = list(big.mark = ",")) %>% #formatting adds (,) 1000s separator
  kable_styling(bootstrap_options = c("striped", "condensed"), 
                full_width = F,
                position = "left") %>% 
  column_spec(1, bold = T)


```


## Demographic breakdowns

### Gender

```{r, echo=FALSE}

#calculate growth for each gender group
gender_states <- votedata %>% 
  group_by(cycle, state, gender) %>% 
  summarise(
    total_returned = sum(ballots_returned, na.rm = TRUE)
  ) %>% 
  pivot_wider(names_from = c(cycle, gender), values_from = total_returned) %>% 
  clean_names() %>% 
  mutate(
    diff_female = x2020_female - x2016_female,
    pctchg_female = round_half_up((x2020_female - x2016_female) / x2016_female * 100, 2),
    diff_male = x2020_male - x2016_male,
    pctchg_male = round_half_up((x2020_male - x2016_male) / x2016_male * 100, 2),
    diff_unknown = x2020_unknown - x2016_unknown,
    pctchg_unknown = round_half_up((x2020_unknown - x2016_unknown) / x2016_unknown * 100, 2)
  ) 

#add totals for each cycle and pct totals
gender_states <- gender_states %>% 
  mutate(
    x2016_total = x2016_female + x2016_male + x2016_unknown,
    x2020_total = x2020_female + x2020_male + x2020_unknown,
    x2016_pcttotal_female = round_half_up(x2016_female / x2016_total * 100, 2),
    x2020_pcttotal_female = round_half_up(x2020_female / x2020_total * 100, 2),
    x2016_pcttotal_male = round_half_up(x2016_male / x2016_total * 100, 2),
    x2020_pcttotal_male = round_half_up(x2020_male / x2020_total * 100, 2),
    x2016_pcttotal_unknown = round_half_up(x2016_unknown / x2016_total * 100, 2),
    x2020_pcttotal_unknown = round_half_up(x2020_unknown / x2020_total * 100, 2),
    pct_chg_disparity_male_female = abs(pctchg_female - pctchg_male)
  )

# head(gender_states)

```


Growth in male vs. female early voters 

```{r, echo=FALSE}

#for displaying
gender_states %>% 
  select(
    state,
    "difference from 2016 in ballots cast by female voters" = diff_female,
    "difference from 2016 in ballots cast by male voters" = diff_male,
    "pct change from 2016 in ballots cast by female voters" = pctchg_female,
    "pct change from 2016 in ballots cast by male voters" = pctchg_male
  ) %>% 
  kable(format.args = list(big.mark = ",")) %>% #formatting adds (,) 1000s separator
  kable_styling(bootstrap_options = c("striped", "condensed"), 
                full_width = F,
                position = "left") %>% 
  column_spec(1, bold = T)


```


### Age Groups


```{r, echo=FALSE}

# votedata

age_states <- votedata %>% 
  group_by(cycle, state, age) %>% 
  summarise(
    total_returned = sum(ballots_returned, na.rm = TRUE)
  ) %>% 
  pivot_wider(names_from = c(cycle), values_from = total_returned) %>% 
  clean_names() %>% 
  mutate(
    diff = x2020 - x2016,
    pctchg = round_half_up((x2020 - x2016) / x2016 * 100, 2)
  ) 

# age_states  
  
```


Growth in early voters by age groups to date, compared with the same point before the 2016 election. The table below shows the **percent change** in 2020 compared with 2016 at the same point before the election.

```{r, echo=FALSE}


#for display 
age_states %>% 
  select(state, age, pctchg) %>% 
  filter(age != "Unknown") %>% 
  mutate(pctchg = round_half_up(pctchg, 1)) %>% 
  pivot_wider(names_from = age, values_from = pctchg) %>%
  kable(format.args = list(big.mark = ",")) %>% #formatting adds (,) 1000s separator
  kable_styling(bootstrap_options = c("striped"),
                full_width = F,
                position = "left") %>%
  column_spec(1, bold = T)



```

One thing to note is that for the enormous jumps in 18-21 year old percentages, they almost all start from a very low base, in some instances only a few hundred early votes last time by young voters in that age bracket. It's still notable of course just how much that group has been gangbusters voting early this time, but something to keep in mind as the percentages themselves are sky-high mainly because almost no one voted early in 2016.  
  
Here below is an expanded table showing the particulars behind those percent changes around age brackets in each state.   

```{r, echo=FALSE}

#for display 
age_states %>% 
  select(
    state,
    age,
    "ballots cast at this point in 2016" = x2016,
    "ballots cast so far in 2020" = x2020,
    "difference" = diff,
    "pct change" = pctchg
  ) %>% 
  kable(format.args = list(big.mark = ",")) %>% #formatting adds (,) 1000s separator
  kable_styling(bootstrap_options = c("striped", "condensed"), 
                full_width = F,
                position = "left") %>% 
  column_spec(1, bold = T)


```



### Party Affiliation


```{r, echo=FALSE}

# votedata

party_states <- votedata %>% 
  filter(!state %in% c("TX", "GA")) %>%  #take out these states since no party ID there
  group_by(cycle, state, party_affiliation) %>% 
  summarise(
    total_returned = sum(ballots_returned, na.rm = TRUE)
  ) %>% 
  pivot_wider(names_from = c(cycle), values_from = total_returned) %>% 
  clean_names() %>% 
  mutate(
    diff = x2020 - x2016,
    pctchg = round_half_up((x2020 - x2016) / x2016 * 100, 2)
  ) 

# party_states
  
```


Growth in early voters by their party affiliation to date, compared with the same point before the 2016 election. (Note that some states, such as Texas and Georgia, do not have such affiliations associated with their early voting.)

```{r, echo=FALSE}


# party_states %>% 
#   select(state, party_affiliation, pctchg) %>% 
#   filter(party_affiliation %in% c("Republican", "Democrat")) %>% 
#   mutate(pctchg = round_half_up(pctchg, 1)) %>% 
#   pivot_wider(names_from = party_affiliation, values_from = pctchg) %>%
#   kable(format.args = list(big.mark = ",")) %>% #formatting adds (,) 1000s separator
#   kable_styling(bootstrap_options = c("striped"),
#                 full_width = F,
#                 position = "left") %>%
#   column_spec(1, bold = T)



```


```{r, echo=FALSE}

#for display 
party_states %>% 
  filter(party_affiliation %in% c("Republican", "Democrat")) %>%
  select(
    state,
    party_affiliation,
    "ballots cast at this point in 2016" = x2016,
    "ballots cast so far in 2020" = x2020,
    "difference" = diff,
    "pct change" = pctchg
  ) %>%
  kable(format.args = list(big.mark = ",")) %>% #formatting adds (,) 1000s separator
  kable_styling(bootstrap_options = c("striped", "condensed"),
                full_width = F,
                position = "left") %>%
  column_spec(1, bold = T)


```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```

