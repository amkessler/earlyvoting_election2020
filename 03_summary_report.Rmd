---
title: "2020 Election Early Voting Summaries and Demograhpics"
author: "Aaron Kessler"
date: "10/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(janitor)
library(lubridate)
library(readxl)
library(writexl)
library(tidycensus)
options(scipen = 999)

#run processing script
source("02_analysis.R")

#pull national votes cast/return number for use below
value_national_2016 <- natl_grandtots_bothyears %>% pull(x2016)
value_national_2020 <- natl_grandtots_bothyears %>% pull(x2020)
value_national_pctchg <- natl_grandtots_bothyears %>% pull(pctchg_returned)


```

Bloomberg is partnering with Catalist, a data company that works with Democrats and others, to compile counts of ballots cast before Election Day, either early in-person or by-mail. The data is being provided each weekday morning.

As of the morning of `r format(Sys.Date(), "%B %d, %Y")`, at least **`r format(value_national_2020, big.mark=",")`** votes have been cast early or by mail nationwide, according to data collected by Catalist. This represents a **`r format(value_national_pctchg)`** percent change from 2016, when `r format(value_national_2016, big.mark=",")` votes were cast at this point.  
  
Details on ballots cast in selected states follow:

## Battleground State Totals

```{r, echo=FALSE}

state_grandtots_bothyears %>% 
  filter(state %in% keystates_prez_vector) %>% 
  select("ballots cast at this point 2016" = total_returned_2016,
         "ballots cast at this point 2020" = total_returned_2016,
         difference = diff_returned,
         "percent change" = pctchg_returned)


```

```{r, echo=FALSE}

#select which filtered version of the full dataset to use below, or create new one
votedata <- state_keyprezonly_bothcycles

```


## Gender

```{r, echo=FALSE}

#calculate growth for each gender group
gender_states <- votedata %>% 
  group_by(cycle, state, gender) %>% 
  summarise(
    total_returned = sum(ballots_returned, na.rm = TRUE)
  ) %>% 
  pivot_wider(names_from = c(cycle, gender), values_from = total_returned) %>% 
  clean_names() %>% 
  mutate(
    diff_female = x2020_female - x2016_female,
    pctchg_female = round_half_up((x2020_female - x2016_female) / x2016_female * 100, 2),
    diff_male = x2020_male - x2016_male,
    pctchg_male = round_half_up((x2020_male - x2016_male) / x2016_male * 100, 2),
    diff_unknown = x2020_unknown - x2016_unknown,
    pctchg_unknown = round_half_up((x2020_unknown - x2016_unknown) / x2016_unknown * 100, 2)
  ) 

#add totals for each cycle and pct totals
gender_states <- gender_states %>% 
  mutate(
    x2016_total = x2016_female + x2016_male + x2016_unknown,
    x2020_total = x2020_female + x2020_male + x2020_unknown,
    x2016_pcttotal_female = round_half_up(x2016_female / x2016_total * 100, 2),
    x2020_pcttotal_female = round_half_up(x2020_female / x2020_total * 100, 2),
    x2016_pcttotal_male = round_half_up(x2016_male / x2016_total * 100, 2),
    x2020_pcttotal_male = round_half_up(x2020_male / x2020_total * 100, 2),
    x2016_pcttotal_unknown = round_half_up(x2016_unknown / x2016_total * 100, 2),
    x2020_pcttotal_unknown = round_half_up(x2020_unknown / x2020_total * 100, 2),
    pct_chg_disparity_male_female = abs(pctchg_female - pctchg_male)
  )

head(gender_states)

```


Growth in male vs. female early voters 

```{r, echo=FALSE}

gender_states %>% 
  select(
    state,
    "difference from 2016 in ballots cast by female voters" = diff_female,
    "difference from 2016 in ballots cast by male voters" = diff_male,
    "pct change from 2016 in ballots cast by female voters" = pctchg_female,
    "pct change from 2016 in ballots cast by male voters" = pctchg_male

  )


```


```{r, echo=FALSE}



```


## Age Groups

```{r, echo=FALSE}

# #create our own boiled down age groupings for this analysis portion
# votedata <- votedata %>% 
#   mutate(
#     age = str_trim(age),
#     age_akgroup = case_when(
#                     age == "18-21" ~ "Under 30",
#                     age == "22-29" ~ "Under 30",
#                     age == "30-39" ~ "30-49 years",
#                     age == "40-49" ~ "30-49 years",
#                     age == "50-64" ~ "50-54 years",
#                     age == "65+" ~ "65 and older",
#                     TRUE ~ "unknown"
#     )
#   )
# 
# votedata %>% 
#   count(age_akgroup)

```


```{r, echo=FALSE}

votedata

votedata %>% 
  group_by(cycle, state, age) %>% 
  summarise(
    total_returned = sum(ballots_returned, na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  group_by(state) %>% 
  mutate(Percentage=total_returned/sum(total_returned)*100)
    
  # ) %>% 
  # pivot_wider(names_from = c(cycle, gender), values_from = total_returned) %>% 
  # clean_names()


```


```{r, echo=FALSE}


#calculate growth for each gender group
age_states <- votedata %>% 
  group_by(cycle, state, age) %>% 
  summarise(
    total_returned = sum(ballots_returned, na.rm = TRUE)
  ) %>% 
  pivot_wider(names_from = c(cycle, age), values_from = total_returned) %>% 
  clean_names() %>% 
  mutate(
    diff_18_21 = x2020_18_21 - x2016_18_21,
    pctchg_18_21 = round_half_up((x2020_18_21 - x2016_18_21) / x2016_18_21 * 100, 2),
    
    diff_22_29 = x2020_22_29 - x2016_22_29,
    pctchg_22_29 = round_half_up((x2020_22_29 - x2016_22_29) / x2016_22_29 * 100, 2),
    
    diff_30_39 = x2020_30_39 - x2016_30_39,
    pctchg_30_39 = round_half_up((x2020_30_39 - x2016_30_39) / x2016_30_39 * 100, 2),
    
    diff_40_49 = x2020_40_49 - x2016_40_49,
    pctchg_40_49 = round_half_up((x2020_40_49 - x2016_40_49) / x2016_40_49 * 100, 2),
    
    diff_50_64 = x2020_50_64 - x2016_50_64,
    pctchg_50_64 = round_half_up((x2020_50_64 - x2016_50_64) / x2016_50_64 * 100, 2),
    
    diff_65 = x2020_65 - x2016_65,
    pctchg_65 = round_half_up((x2020_65 - x2016_65) / x2016_65 * 100, 2),
    
    diff_unknown = x2020_unknown - x2016_unknown,
    pctchg_unknown = round_half_up((x2020_unknown - x2016_unknown) / x2016_unknown * 100, 2),
    
  ) 


head(age_states)

```

Growth in male vs. female early voters 

```{r, echo=FALSE}

age_states_fordisplay <- age_states %>% 
  select(
    state,
    "difference in ballots cast by age 18-21" = diff_18_21,
    "pct change in ballots cast by age 18-21" = pctchg_18_21,
    "difference in ballots cast by age 22-29" = diff_22_29,
    "pct change in ballots cast by age 22-29" = pctchg_22_29,
    "difference in ballots cast by age 30-39" = diff_30_39,
    "pct change in ballots cast by age 30-39" = pctchg_30_39,
    "difference in ballots cast by age 40-49" = diff_40_49,
    "pct change in ballots cast by age 40-49" = pctchg_40_49,
    "difference in ballots cast by age 50-64" = diff_50_64,
    "pct change in ballots cast by age 50-64" = pctchg_50_64,
    "difference in ballots cast by age 65+" = diff_65,
    "pct change in ballots cast by age 65+" = pctchg_65,

  )

age_states_fordisplay

```




```{r, echo=FALSE}




```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```


```{r, echo=FALSE}




```

